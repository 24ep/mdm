// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  name      String
  password  String
  role      String   @default("USER")
  avatar    String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  // Security & Status
  isActive               Boolean   @default(true) @map("is_active")
  passwordChangedAt      DateTime? @map("password_changed_at")
  requiresPasswordChange Boolean   @default(false) @map("requires_password_change")
  failedLoginAttempts    Int       @default(0) @map("failed_login_attempts")
  lockoutUntil           DateTime? @map("lockout_until")

  // Relations
  createdSpaces                Space[]                       @relation("SpaceCreator")
  spaceMemberships             SpaceMember[]                 @relation("UserSpaceMembers")
  createdDataModels            DataModel[]                   @relation("DataModelCreator")
  createdDataRecords           DataRecord[]                  @relation("DataRecordCreator")
  createdEavEntities           EavEntity[]                   @relation("EavEntityCreator")
  notifications                Notification[]                @relation("UserNotifications")
  teamMemberships              TeamMember[]                  @relation("UserTeamMembers")
  chatSessions                 ChatSession[]                 @relation("UserChatSessions")
  auditLogs                    AuditLog[]                    @relation("UserAuditLogs")
  createdTickets               Ticket[]                      @relation("TicketCreator")
  assignedTickets              TicketAssignee[]              @relation("TicketAssignees")
  ticketComments               TicketComment[]               @relation("TicketCommentAuthor")
  ticketTimeLogs               TicketTimeLog[]               @relation("TicketTimeLogUser")
  createdProjects              Project[]                     @relation("ProjectCreator")
  createdMilestones            Milestone[]                   @relation("MilestoneCreator")
  createdReleases              Release[]                     @relation("ReleaseCreator")
  createdModules               Module[]                      @relation("ModuleCreator")
  createdCycles                Cycle[]                       @relation("CycleCreator")
  leadModules                  Module[]                      @relation("ModuleLead")
  intakeSubmissions            IntakeSubmission[]            @relation("IntakeSubmissionUser")
  importProfiles               ImportProfile[]               @relation("ImportProfileCreator")
  importJobs                   ImportJob[]                   @relation("ImportJobCreator")
  exportJobs                   ExportJob[]                   @relation("ExportJobCreator")
  createdChatbots              Chatbot[]                     @relation("ChatbotCreator")
  chatbotVersions              ChatbotVersion[]              @relation("ChatbotVersionCreator")
  agentThreads                 OpenAIAgentThread[]           @relation("UserAgentThreads")
  costRecords                  ChatbotCostRecord[]           @relation("UserCostRecords")
  serviceInstallations         ServiceInstallation[]         @relation("UserServiceInstallations")
  infrastructureInstances      InfrastructureInstance[]      @relation("UserInfrastructureInstances")
  serviceManagementAssignments ServiceManagementAssignment[] @relation("UserServiceManagementAssignments")
  pluginReviews                PluginReview[]                @relation("UserPluginReviews")
  pluginReviewHelpful          PluginReviewHelpful[]         @relation("UserPluginReviewHelpful")
  apiWorkspaces                ApiWorkspace[]                @relation("UserApiWorkspaces")
  apiCollections               ApiCollection[]               @relation("UserApiCollections")
  apiRequests                  ApiRequest[]                  @relation("UserApiRequests")
  apiEnvironments              ApiEnvironment[]              @relation("UserApiEnvironments")
  apiRequestHistory            ApiRequestHistory[]           @relation("UserApiRequestHistory")
  knowledgeCollections         KnowledgeCollection[]         @relation("UserKnowledgeCollections")
  knowledgeCollectionMembers   KnowledgeCollectionMember[]   @relation("UserKnowledgeCollectionMembers")
  knowledgeDocuments           KnowledgeDocument[]           @relation("UserKnowledgeDocuments")
  knowledgeDocumentUpdates     KnowledgeDocument[]           @relation("UserKnowledgeDocumentUpdates")
  knowledgeDocumentVersions    KnowledgeDocumentVersion[]    @relation("UserKnowledgeDocumentVersions")
  knowledgeComments            KnowledgeComment[]            @relation("UserKnowledgeComments")
  knowledgeCommentResolutions  KnowledgeComment[]            @relation("UserKnowledgeCommentResolutions")
  knowledgeShares              KnowledgeShare[]              @relation("UserKnowledgeShares")
  knowledgeShareCreators       KnowledgeShare[]              @relation("UserKnowledgeShareCreators")
  knowledgeStars               KnowledgeStar[]               @relation("UserKnowledgeStars")
  knowledgeMentions            KnowledgeMention[]            @relation("UserKnowledgeMentions")
  knowledgeMentionCreators     KnowledgeMention[]            @relation("UserKnowledgeMentionCreators")
  knowledgePresence            KnowledgePresence[]           @relation("UserKnowledgePresence")
  createdWebsitePWAs           WebsitePWA[]                  @relation("WebsitePWACreator")
  websitePWAVersions           WebsitePWAVersion[]           @relation("WebsitePWAVersionCreator")

  @@map("users")
}

model Space {
  id                 String    @id @default(uuid()) @db.Uuid
  name               String
  description        String?
  slug               String    @unique
  isDefault          Boolean   @default(false) @map("is_default")
  isActive           Boolean   @default(true) @map("is_active")
  icon               String?
  logoUrl            String?   @map("logo_url")
  features           Json?     @default("{}")
  sidebarConfig      Json?     @map("sidebar_config")
  enableAssignments  Boolean   @default(true) @map("enable_assignments")
  enableBulkActivity Boolean   @default(true) @map("enable_bulk_activity")
  enableWorkflows    Boolean   @default(true) @map("enable_workflows")
  enableDashboard    Boolean   @default(true) @map("enable_dashboard")
  createdBy          String    @map("created_by") @db.Uuid
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  deletedAt          DateTime? @map("deleted_at")

  // Relations
  creator                 User                     @relation("SpaceCreator", fields: [createdBy], references: [id])
  members                 SpaceMember[]            @relation("SpaceMembers")
  dataModels              DataModelSpace[]         @relation("SpaceDataModels")
  attachmentStorage       SpaceAttachmentStorage[] @relation("SpaceAttachments")
  externalConnections     ExternalConnection[]     @relation("SpaceExternalConnections")
  notebooks               Notebook[]               @relation("SpaceNotebooks")
  chatSessions            ChatSession[]            @relation("SpaceChatSessions")
  ticketSpaces            TicketSpace[]            @relation("SpaceTicketSpaces")
  kanbanConfigs           KanbanConfig[]           @relation("SpaceKanbanConfigs")
  intakeForms             IntakeForm[]             @relation("SpaceIntakeForms")
  projects                Project[]                @relation("SpaceProjects")
  importProfiles          ImportProfile[]          @relation("SpaceImportProfiles")
  importJobs              ImportJob[]              @relation("SpaceImportJobs")
  exportJobs              ExportJob[]              @relation("SpaceExportJobs")
  chatbots                Chatbot[]                @relation("SpaceChatbots")
  agentThreads            OpenAIAgentThread[]      @relation("SpaceAgentThreads")
  serviceInstallations    ServiceInstallation[]    @relation("SpaceServiceInstallations")
  infrastructureInstances InfrastructureInstance[] @relation("SpaceInfrastructureInstances")
  pluginReviews           PluginReview[]           @relation("SpacePluginReviews")
  knowledgeCollections    KnowledgeCollection[]    @relation("SpaceKnowledgeCollections")
  apiWorkspaces           ApiWorkspace[]           @relation("SpaceApiWorkspaces")
  websitePWAs             WebsitePWA[]             @relation("SpaceWebsitePWAs")

  @@map("spaces")
}

model SpaceMember {
  id      String @id @default(uuid()) @db.Uuid
  spaceId String @map("space_id") @db.Uuid
  userId  String @map("user_id") @db.Uuid
  role    String @default("MEMBER")

  // Relations
  space Space @relation("SpaceMembers", fields: [spaceId], references: [id], onDelete: Cascade)
  user  User  @relation("UserSpaceMembers", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([spaceId, userId])
  @@map("space_members")
}

// Enhanced EAV Entity Types
model EntityType {
  id          String    @id @default(uuid()) @db.Uuid
  name        String    @unique
  displayName String    @map("display_name")
  description String?
  parentId    String?   @map("parent_id") @db.Uuid
  isAbstract  Boolean   @default(false) @map("is_abstract")
  isActive    Boolean   @default(true) @map("is_active")
  sortOrder   Int       @default(0) @map("sort_order")
  metadata    Json?     @default("{}")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  parent               EntityType?            @relation("EntityTypeHierarchy", fields: [parentId], references: [id])
  children             EntityType[]           @relation("EntityTypeHierarchy")
  attributes           EavAttribute[]         @relation("EntityTypeAttributes")
  entities             EavEntity[]            @relation("EntityTypeEntities")
  attributeGroups      AttributeGroup[]       @relation("EntityTypeAttributeGroups")
  referencedAttributes EavAttribute[]         @relation("ReferenceEntityType")
  childInheritances    AttributeInheritance[] @relation("ChildEntityType")
  parentInheritances   AttributeInheritance[] @relation("ParentEntityType")

  @@map("entity_types")
}

// Attribute Groups for better organization
model AttributeGroup {
  id            String   @id @default(uuid()) @db.Uuid
  name          String
  displayName   String   @map("display_name")
  description   String?
  entityTypeId  String   @map("entity_type_id") @db.Uuid
  sortOrder     Int      @default(0) @map("sort_order")
  isCollapsible Boolean  @default(true) @map("is_collapsible")
  isRequired    Boolean  @default(false) @map("is_required")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  entityType EntityType     @relation("EntityTypeAttributeGroups", fields: [entityTypeId], references: [id], onDelete: Cascade)
  attributes EavAttribute[] @relation("AttributeGroupAttributes")

  @@map("attribute_groups")
}

// Enhanced EAV Attributes
model EavAttribute {
  id          String  @id @default(uuid()) @db.Uuid
  name        String
  displayName String  @map("display_name")
  description String?

  // Entity relationship
  entityTypeId     String  @map("entity_type_id") @db.Uuid
  attributeGroupId String? @map("attribute_group_id") @db.Uuid

  // Data type and constraints
  dataType    String @map("data_type") // eav_data_type enum
  cardinality String @default("SINGLE") // attribute_cardinality enum
  scope       String @default("INSTANCE") // attribute_scope enum

  // Validation and constraints
  isRequired   Boolean @default(false) @map("is_required")
  isUnique     Boolean @default(false) @map("is_unique")
  isIndexed    Boolean @default(false) @map("is_indexed")
  isSearchable Boolean @default(true) @map("is_searchable")
  isAuditable  Boolean @default(true) @map("is_auditable")

  // Default values and options
  defaultValue    String? @map("default_value")
  options         Json?   @default("{}")
  validationRules Json?   @default("{}") @map("validation_rules")

  // UI and display
  sortOrder   Int     @default(0) @map("sort_order")
  isVisible   Boolean @default(true) @map("is_visible")
  isEditable  Boolean @default(true) @map("is_editable")
  helpText    String? @map("help_text")
  placeholder String?

  // Reference attributes (for foreign keys)
  referenceEntityTypeId String? @map("reference_entity_type_id") @db.Uuid
  referenceDisplayField String? @map("reference_display_field")

  // Auto-increment support
  isAutoIncrement           Boolean @default(false) @map("is_auto_increment")
  autoIncrementPrefix       String  @default("") @map("auto_increment_prefix")
  autoIncrementSuffix       String  @default("") @map("auto_increment_suffix")
  autoIncrementStart        Int     @default(1) @map("auto_increment_start")
  autoIncrementPadding      Int     @default(3) @map("auto_increment_padding")
  currentAutoIncrementValue Int     @default(0) @map("current_auto_increment_value")

  // External system integration
  externalColumn  String? @map("external_column")
  externalMapping Json?   @default("{}") @map("external_mapping")

  // Metadata
  metadata  Json?     @default("{}")
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  entityType          EntityType             @relation("EntityTypeAttributes", fields: [entityTypeId], references: [id], onDelete: Cascade)
  attributeGroup      AttributeGroup?        @relation("AttributeGroupAttributes", fields: [attributeGroupId], references: [id], onDelete: SetNull)
  referenceEntityType EntityType?            @relation("ReferenceEntityType", fields: [referenceEntityTypeId], references: [id])
  values              EavValue[]             @relation("AttributeValues")
  dependencies        AttributeDependency[]  @relation("DependentAttributes")
  dependents          AttributeDependency[]  @relation("DependsOnAttributes")
  inheritances        AttributeInheritance[] @relation("AttributeInheritances")

  @@unique([entityTypeId, name])
  @@map("eav_attributes")
}

// Enhanced Entity Instances
model EavEntity {
  id           String    @id @default(uuid()) @db.Uuid
  entityTypeId String    @map("entity_type_id") @db.Uuid
  externalId   String?   @map("external_id")
  isActive     Boolean   @default(true) @map("is_active")
  metadata     Json?     @default("{}")
  createdBy    String?   @map("created_by") @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  // Relations
  entityType EntityType @relation("EntityTypeEntities", fields: [entityTypeId], references: [id], onDelete: Cascade)
  creator    User?      @relation("EavEntityCreator", fields: [createdBy], references: [id])
  values     EavValue[] @relation("EntityValues")

  @@unique([entityTypeId, externalId])
  @@map("eav_entities")
}

// Enhanced Values table with type-specific columns
model EavValue {
  id          String @id @default(uuid()) @db.Uuid
  entityId    String @map("entity_id") @db.Uuid
  attributeId String @map("attribute_id") @db.Uuid

  // Type-specific value columns for better performance
  textValue     String?   @map("text_value")
  numberValue   Decimal?  @map("number_value") @db.Decimal(20, 6)
  booleanValue  Boolean?  @map("boolean_value")
  dateValue     DateTime? @map("date_value") @db.Date
  datetimeValue DateTime? @map("datetime_value")
  jsonValue     Json?     @map("json_value")
  blobValue     Bytes?    @map("blob_value")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  entity    EavEntity    @relation("EntityValues", fields: [entityId], references: [id], onDelete: Cascade)
  attribute EavAttribute @relation("AttributeValues", fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([entityId, attributeId])
  @@map("eav_values")
}

// Attribute Dependencies for complex relationships
model AttributeDependency {
  id                   String   @id @default(uuid()) @db.Uuid
  dependentAttributeId String   @map("dependent_attribute_id") @db.Uuid
  dependsOnAttributeId String   @map("depends_on_attribute_id") @db.Uuid
  conditionType        String   @map("condition_type")
  conditionValue       String?  @map("condition_value")
  isActive             Boolean  @default(true) @map("is_active")
  createdAt            DateTime @default(now()) @map("created_at")

  // Relations
  dependentAttribute EavAttribute @relation("DependentAttributes", fields: [dependentAttributeId], references: [id], onDelete: Cascade)
  dependsOnAttribute EavAttribute @relation("DependsOnAttributes", fields: [dependsOnAttributeId], references: [id], onDelete: Cascade)

  @@map("attribute_dependencies")
}

// Attribute Inheritance for entity type hierarchies
model AttributeInheritance {
  id                 String   @id @default(uuid()) @db.Uuid
  childEntityTypeId  String   @map("child_entity_type_id") @db.Uuid
  parentEntityTypeId String   @map("parent_entity_type_id") @db.Uuid
  attributeId        String   @map("attribute_id") @db.Uuid
  inheritanceType    String   @default("INHERIT") @map("inheritance_type")
  overriddenMetadata Json?    @default("{}") @map("overridden_metadata")
  createdAt          DateTime @default(now()) @map("created_at")

  // Relations
  childEntityType  EntityType   @relation("ChildEntityType", fields: [childEntityTypeId], references: [id], onDelete: Cascade)
  parentEntityType EntityType   @relation("ParentEntityType", fields: [parentEntityTypeId], references: [id], onDelete: Cascade)
  attribute        EavAttribute @relation("AttributeInheritances", fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([childEntityTypeId, attributeId])
  @@map("attribute_inheritance")
}

// Value History for audit trail
model EavValueHistory {
  id               String    @id @default(uuid()) @db.Uuid
  entityId         String    @map("entity_id") @db.Uuid
  attributeId      String    @map("attribute_id") @db.Uuid
  oldTextValue     String?   @map("old_text_value")
  oldNumberValue   Decimal?  @map("old_number_value") @db.Decimal(20, 6)
  oldBooleanValue  Boolean?  @map("old_boolean_value")
  oldDateValue     DateTime? @map("old_date_value") @db.Date
  oldDatetimeValue DateTime? @map("old_datetime_value")
  oldJsonValue     Json?     @map("old_json_value")
  oldBlobValue     Bytes?    @map("old_blob_value")
  newTextValue     String?   @map("new_text_value")
  newNumberValue   Decimal?  @map("new_number_value") @db.Decimal(20, 6)
  newBooleanValue  Boolean?  @map("new_boolean_value")
  newDateValue     DateTime? @map("new_date_value") @db.Date
  newDatetimeValue DateTime? @map("new_datetime_value")
  newJsonValue     Json?     @map("new_json_value")
  newBlobValue     Bytes?    @map("new_blob_value")
  changedBy        String?   @map("changed_by") @db.Uuid
  changeReason     String?   @map("change_reason")
  createdAt        DateTime  @default(now()) @map("created_at")

  @@map("eav_value_history")
}

// Legacy DataModel for backward compatibility
model DataModel {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  description String?
  sortOrder   Int       @default(0) @map("sort_order")
  isActive    Boolean   @default(true) @map("is_active")
  createdBy   String    @map("created_by") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  creator             User                 @relation("DataModelCreator", fields: [createdBy], references: [id])
  spaces              DataModelSpace[]     @relation("DataModelSpaces")
  attributes          Attribute[]          @relation("DataModelAttributes")
  dataRecords         DataRecord[]         @relation("DataModelRecords")
  externalConnections ExternalConnection[] @relation("ExternalConnectionDataModels")

  @@map("data_models")
}

model DataModelSpace {
  id          String   @id @default(uuid()) @db.Uuid
  dataModelId String   @map("data_model_id") @db.Uuid
  spaceId     String   @map("space_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  dataModel DataModel @relation("DataModelSpaces", fields: [dataModelId], references: [id], onDelete: Cascade)
  space     Space     @relation("SpaceDataModels", fields: [spaceId], references: [id], onDelete: Cascade)

  @@unique([dataModelId, spaceId])
  @@map("data_model_spaces")
}

// Legacy Attribute model for backward compatibility
model Attribute {
  id              String    @id @default(uuid()) @db.Uuid
  name            String
  displayName     String    @map("display_name")
  type            String
  description     String?
  isRequired      Boolean   @default(false) @map("is_required")
  isUnique        Boolean   @default(false) @map("is_unique")
  isPrimaryKey    Boolean?  @default(false) @map("is_primary_key")
  isForeignKey    Boolean?  @default(false) @map("is_foreign_key")
  defaultValue    String?   @map("default_value")
  validationRules Json?     @map("validation_rules")
  options         Json?
  order           Int       @default(0) @map("order")
  isActive        Boolean   @default(true) @map("is_active")
  deletedAt       DateTime? @map("deleted_at")

  // Data entity support
  dataEntityModelId     String? @map("data_entity_model_id")
  dataEntityAttributeId String? @map("data_entity_attribute_id")

  // Auto-increment support
  isAutoIncrement           Boolean @default(false) @map("is_auto_increment")
  autoIncrementPrefix       String  @default("") @map("auto_increment_prefix")
  autoIncrementSuffix       String  @default("") @map("auto_increment_suffix")
  autoIncrementStart        Int     @default(1) @map("auto_increment_start")
  autoIncrementPadding      Int     @default(3) @map("auto_increment_padding")
  currentAutoIncrementValue Int     @default(0) @map("current_auto_increment_value")

  // External connection support
  externalColumn String? @map("external_column")

  dataModelId String   @map("data_model_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  dataModel        DataModel         @relation("DataModelAttributes", fields: [dataModelId], references: [id], onDelete: Cascade)
  dataRecordValues DataRecordValue[] @relation("AttributeValues")

  @@map("data_model_attributes")
}

model ExternalConnection {
  id        String    @id @default(uuid()) @db.Uuid
  spaceId   String    @map("space_id") @db.Uuid
  name      String
  dbType    String    @map("db_type") // 'postgres' | 'mysql'
  host      String
  port      Int?
  database  String?
  username  String
  password  String
  options   Json?
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  space      Space       @relation("SpaceExternalConnections", fields: [spaceId], references: [id], onDelete: Cascade)
  dataModels DataModel[] @relation("ExternalConnectionDataModels")

  @@map("external_connections")
}

model Team {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  members     TeamMember[]     @relation("TeamMembers")
  permissions TeamPermission[] @relation("TeamPermissions")

  @@map("teams")
}

model TeamMember {
  id     String @id @default(uuid()) @db.Uuid
  teamId String @map("team_id") @db.Uuid
  userId String @map("user_id") @db.Uuid
  role   String @default("member")

  // Relations
  team Team @relation("TeamMembers", fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation("UserTeamMembers", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_members")
}

model Permission {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @unique
  description String?
  resource    String
  action      String

  // Relations
  teamPermissions TeamPermission[] @relation("PermissionTeamPermissions")
  rolePermissions RolePermission[] @relation("PermissionRolePermissions")

  @@map("permissions")
}

model TeamPermission {
  id           String @id @default(uuid()) @db.Uuid
  teamId       String @map("team_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid

  // Relations
  team       Team       @relation("TeamPermissions", fields: [teamId], references: [id], onDelete: Cascade)
  permission Permission @relation("PermissionTeamPermissions", fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([teamId, permissionId])
  @@map("team_permissions")
}

model Role {
  id          String  @id @default(uuid()) @db.Uuid
  name        String  @unique
  description String?
  level       String  @default("space") // 'global' or 'space'
  isSystem    Boolean @default(false) @map("is_system")

  // Relations
  permissions RolePermission[] @relation("RolePermissions")

  @@map("roles")
}

model RolePermission {
  id           String @id @default(uuid()) @db.Uuid
  roleId       String @map("role_id") @db.Uuid
  permissionId String @map("permission_id") @db.Uuid

  // Relations
  role       Role       @relation("RolePermissions", fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation("PermissionRolePermissions", fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// Hardcoded models removed - now using EAV entities
// Company, Source, Industry, Event, Position, BusinessProfile, Title, CallWorkflowStatus
// are now managed as EAV entities with entity types: company, source, industry, event, position, business_profile, title, call_workflow_status

// Legacy DataRecord model for backward compatibility
model DataRecord {
  id          String    @id @default(uuid()) @db.Uuid
  dataModelId String    @map("data_model_id") @db.Uuid
  createdBy   String    @map("created_by") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  dataModel DataModel         @relation("DataModelRecords", fields: [dataModelId], references: [id], onDelete: Cascade)
  creator   User              @relation("DataRecordCreator", fields: [createdBy], references: [id])
  values    DataRecordValue[] @relation("RecordValues")

  @@map("data_records")
}

// Legacy DataRecordValue model for backward compatibility
model DataRecordValue {
  id           String   @id @default(uuid()) @db.Uuid
  dataRecordId String   @map("data_record_id") @db.Uuid
  attributeId  String   @map("attribute_id") @db.Uuid
  value        String?
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  dataRecord DataRecord @relation("RecordValues", fields: [dataRecordId], references: [id], onDelete: Cascade)
  attribute  Attribute  @relation("AttributeValues", fields: [attributeId], references: [id], onDelete: Cascade)

  @@unique([dataRecordId, attributeId])
  @@map("data_record_values")
}

model Notification {
  id          String    @id @default(uuid()) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  type        String
  title       String
  message     String
  priority    String    @default("MEDIUM")
  status      String    @default("UNREAD")
  data        Json?
  actionUrl   String?   @map("action_url")
  actionLabel String?   @map("action_label")
  expiresAt   DateTime? @map("expires_at")
  readAt      DateTime? @map("read_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user User @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model SystemSetting {
  id        String   @id @default(uuid()) @db.Uuid
  key       String   @unique
  value     String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model PlatformIntegration {
  id        String    @id @default(uuid()) @db.Uuid
  type      String    // 'signoz', etc.
  config    Json?     @default("{}")
  status    String    @default("active")
  isEnabled Boolean   @default(true) @map("is_enabled")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("platform_integrations")
}

model SpaceAttachmentStorage {
  id        String   @id @default(uuid()) @db.Uuid
  spaceId   String   @map("space_id") @db.Uuid
  fileName  String   @map("file_name")
  filePath  String   @map("file_path")
  fileSize  Int      @map("file_size")
  mimeType  String   @map("mime_type")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  space Space @relation("SpaceAttachments", fields: [spaceId], references: [id], onDelete: Cascade)

  @@map("space_attachment_storage")
}

model AttachmentFile {
  id        String   @id @default(uuid()) @db.Uuid
  fileName  String   @map("file_name")
  filePath  String   @map("file_path")
  fileSize  Int      @map("file_size")
  mimeType  String   @map("mime_type")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("attachment_files")
}

// Cache Management Models
model CacheInstance {
  id            String    @id @default(uuid()) @db.Uuid
  name          String
  type          String // 'redis', 'memcached', 'memory', 'file'
  host          String
  port          Int
  password      String?
  isActive      Boolean   @default(true) @map("is_active")
  status        String    @default("disconnected") // 'connected', 'disconnected', 'error'
  lastConnected DateTime? @map("last_connected")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  keys  CacheKey[]
  stats CacheStats[]

  @@map("cache_instances")
}

// Kong Gateway Management Models
model KongInstance {
  id            String    @id @default(uuid()) @db.Uuid
  name          String
  adminUrl      String    @map("admin_url") // Kong Admin API URL (e.g., http://kong:8001)
  adminApiKey   String?   @map("admin_api_key") // Optional API key for Admin API authentication
  description   String?
  isActive      Boolean   @default(true) @map("is_active")
  status        String    @default("disconnected") // 'connected', 'disconnected', 'error'
  lastConnected DateTime? @map("last_connected")
  metadata      Json?     @default("{}") // Additional configuration (timeout, retries, etc.)
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("kong_instances")
}

model CacheKey {
  id           String    @id @default(uuid()) @db.Uuid
  instanceId   String    @map("instance_id") @db.Uuid
  key          String
  value        String
  type         String    @default("string")
  size         Int       @default(0)
  ttl          Int? // Time to live in seconds
  hitCount     Int       @default(0) @map("hit_count")
  lastAccessed DateTime? @map("last_accessed")
  isExpired    Boolean   @default(false) @map("is_expired")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  instance CacheInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, key])
  @@map("cache_keys")
}

model CacheStats {
  id                String   @id @default(uuid()) @db.Uuid
  instanceId        String   @map("instance_id") @db.Uuid
  totalKeys         Int      @default(0) @map("total_keys")
  memoryUsage       BigInt   @default(0) @map("memory_usage")
  hitRate           Float    @default(0) @map("hit_rate")
  missRate          Float    @default(0) @map("miss_rate")
  evictionRate      Float    @default(0) @map("eviction_rate")
  avgResponseTime   Float    @default(0) @map("avg_response_time")
  connections       Int      @default(0)
  commandsPerSecond Int      @default(0) @map("commands_per_second")
  hits              Int      @default(0)
  misses            Int      @default(0)
  evictions         Int      @default(0)
  expired           Int      @default(0)
  createdAt         DateTime @default(now()) @map("created_at")

  // Relations
  instance CacheInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@map("cache_stats")
}

model CacheConfig {
  id             String   @id @default(uuid()) @db.Uuid
  instanceId     String   @map("instance_id") @db.Uuid
  maxMemory      String   @map("max_memory")
  evictionPolicy String   @map("eviction_policy")
  ttl            Int      @default(3600)
  compression    Boolean  @default(false)
  persistence    Boolean  @default(false)
  clustering     Boolean  @default(false)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@unique([instanceId])
  @@map("cache_configs")
}

model Notebook {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  description String?
  content     Json?     @default("{}")
  cells       Json?     @default("[]")
  tags        String[]  @default([])
  isPublic    Boolean   @default(false) @map("is_public")
  author      String
  spaceId     String?   @map("space_id") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  space Space? @relation("SpaceNotebooks", fields: [spaceId], references: [id], onDelete: Cascade)

  @@map("notebooks")
}

model AIProviderConfig {
  id            String    @id @default(uuid()) @db.Uuid
  provider      String    @unique
  name          String
  description   String?
  website       String?
  icon          String?
  isSupported   Boolean   @default(true) @map("is_supported")
  apiKey        String?   @map("api_key")
  baseUrl       String?   @map("base_url")
  customHeaders Json?     @default("{}") @map("custom_headers")
  timeout       Int       @default(30000)
  retryAttempts Int       @default(3) @map("retry_attempts")
  status        String    @default("inactive") // active, inactive, error, pending
  isConfigured  Boolean   @default(false) @map("is_configured")
  lastTested    DateTime? @map("last_tested")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  @@map("ai_provider_configs")
}

model AIModel {
  id           String        @id @default(uuid()) @db.Uuid
  name         String
  provider     String
  type         String // text, image, code, multimodal
  description  String?
  maxTokens    Int           @map("max_tokens")
  costPerToken Float         @map("cost_per_token")
  isAvailable  Boolean       @default(true) @map("is_available")
  capabilities Json?         @default("[]")
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  chatSessions ChatSession[] @relation("ModelChatSessions")

  @@map("ai_models")
}

model ChatSession {
  id          String    @id @default(uuid()) @db.Uuid
  title       String
  description String?
  isPrivate   Boolean   @default(false) @map("is_private")
  userId      String    @map("user_id") @db.Uuid
  spaceId     String?   @map("space_id") @db.Uuid
  modelId     String?   @map("model_id") @db.Uuid
  messages    Json?     @default("[]")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  user  User     @relation("UserChatSessions", fields: [userId], references: [id], onDelete: Cascade)
  space Space?   @relation("SpaceChatSessions", fields: [spaceId], references: [id], onDelete: Cascade)
  model AIModel? @relation("ModelChatSessions", fields: [modelId], references: [id], onDelete: SetNull)

  @@map("chat_sessions")
}

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  action     String // CREATE, UPDATE, DELETE, etc.
  entityType String   @map("entity_type") // attribute, data_model, etc.
  entityId   String   @map("entity_id") @db.Uuid
  oldValue   String?  @map("old_value") // JSON string
  newValue   String?  @map("new_value") // JSON string
  userId     String?  @map("user_id") @db.Uuid
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation("UserAuditLogs", fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

// Project Management - Projects
model Project {
  id          String     @id @default(uuid()) @db.Uuid
  name        String
  description String?
  status      String     @default("PLANNING") // PLANNING, ACTIVE, ON_HOLD, COMPLETED, CANCELLED
  startDate   DateTime?  @map("start_date")
  endDate     DateTime?  @map("end_date")
  spaceId     String     @map("space_id") @db.Uuid
  createdBy   String     @map("created_by") @db.Uuid
  metadata    Json?      @default("{}")
  createdAt   DateTime   @default(now()) @map("created_at")
  updatedAt   DateTime   @updatedAt @map("updated_at")
  deletedAt   DateTime?  @map("deleted_at")

  // Relations
  space      Space       @relation("SpaceProjects", fields: [spaceId], references: [id], onDelete: Cascade)
  creator    User        @relation("ProjectCreator", fields: [createdBy], references: [id])
  milestones Milestone[] @relation("ProjectMilestones")
  releases   Release[]   @relation("ProjectReleases")
  modules    Module[]    @relation("ProjectModules")
  tickets    Ticket[]    @relation("ProjectTickets")
  cycles     Cycle[]     @relation("ProjectCycles")

  @@map("projects")
}

// Project Management - Milestones
model Milestone {
  id          String    @id @default(uuid()) @db.Uuid
  projectId   String    @map("project_id") @db.Uuid
  name        String
  description String?
  status      String    @default("UPCOMING") // UPCOMING, IN_PROGRESS, COMPLETED, CANCELLED
  startDate   DateTime? @map("start_date")
  dueDate     DateTime? @map("due_date")
  completedAt DateTime? @map("completed_at")
  createdBy   String    @map("created_by") @db.Uuid
  metadata    Json?     @default("{}")
  position    Int       @default(0) // For ordering
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  project Project @relation("ProjectMilestones", fields: [projectId], references: [id], onDelete: Cascade)
  creator User    @relation("MilestoneCreator", fields: [createdBy], references: [id])
  tickets Ticket[] @relation("MilestoneTickets")

  @@map("milestones")
}

// Project Management - Releases
model Release {
  id          String    @id @default(uuid()) @db.Uuid
  projectId   String    @map("project_id") @db.Uuid
  name        String    // Release name (e.g., "v1.0.0", "2024 Q1 Release")
  version     String?   // Semantic version (e.g., "1.0.0")
  description String?
  status      String    @default("PLANNED") // PLANNED, IN_PROGRESS, RELEASED, CANCELLED
  releaseDate DateTime? @map("release_date") // Actual release date
  targetDate  DateTime? @map("target_date") // Planned release date
  createdBy   String    @map("created_by") @db.Uuid
  metadata    Json?     @default("{}") // GitLab release info, tags, etc.
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  project Project @relation("ProjectReleases", fields: [projectId], references: [id], onDelete: Cascade)
  creator User    @relation("ReleaseCreator", fields: [createdBy], references: [id])
  tickets Ticket[] @relation("ReleaseTickets")

  @@index([projectId, version])
  @@map("releases")
}

// Project Management - Modules
model Module {
  id          String    @id @default(uuid()) @db.Uuid
  projectId   String    @map("project_id") @db.Uuid
  name        String
  description String?
  status      String    @default("PLANNED") // PLANNED, IN_PROGRESS, COMPLETED, CANCELLED
  startDate   DateTime? @map("start_date")
  targetDate  DateTime? @map("target_date") // Target completion date
  completedAt DateTime? @map("completed_at")
  leadId      String?   @map("lead_id") @db.Uuid // Module lead/owner
  createdBy   String    @map("created_by") @db.Uuid
  metadata    Json?     @default("{}") // Additional metadata
  position    Int       @default(0) // For ordering
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  project Project @relation("ProjectModules", fields: [projectId], references: [id], onDelete: Cascade)
  creator User    @relation("ModuleCreator", fields: [createdBy], references: [id])
  lead    User?   @relation("ModuleLead", fields: [leadId], references: [id], onDelete: SetNull)
  tickets Ticket[] @relation("ModuleTickets")

  @@map("modules")
}

model Cycle {
  id          String    @id @default(uuid()) @db.Uuid
  projectId   String    @map("project_id") @db.Uuid
  name        String
  description String?
  status      String    @default("DRAFT") // DRAFT, UPCOMING, ACTIVE, COMPLETED, CANCELLED
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  completedAt DateTime? @map("completed_at")
  createdBy   String    @map("created_by") @db.Uuid
  metadata    Json?     @default("{}") // Additional metadata
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  project Project @relation("ProjectCycles", fields: [projectId], references: [id], onDelete: Cascade)
  creator User    @relation("CycleCreator", fields: [createdBy], references: [id])
  tickets Ticket[] @relation("CycleTickets")

  @@map("cycles")
}

// Project Management - Tickets
model Ticket {
  id          String    @id @default(uuid()) @db.Uuid
  title       String
  description String?
  status      String    @default("BACKLOG") // BACKLOG, TODO, IN_PROGRESS, IN_REVIEW, DONE, CANCELLED
  priority    String    @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  dueDate     DateTime? @map("due_date")
  startDate   DateTime? @map("start_date")
  completedAt DateTime? @map("completed_at")
  createdBy   String    @map("created_by") @db.Uuid
  estimate    Int? // Story points or hours
  metadata    Json?     @default("{}")
  parentId    String?   @map("parent_id") @db.Uuid // For subtasks
  projectId   String?   @map("project_id") @db.Uuid // Link to project
  milestoneId String?   @map("milestone_id") @db.Uuid // Link to milestone
  releaseId   String?   @map("release_id") @db.Uuid // Link to release
  moduleId    String?   @map("module_id") @db.Uuid // Link to module
  cycleId     String?   @map("cycle_id") @db.Uuid
  type        String    @default("ISSUE") // ISSUE, BUG, FEATURE, TASK
  position    Int       @default(0) // For ordering
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  spaces       TicketSpace[]      @relation("TicketSpaces")
  assignees    TicketAssignee[]   @relation("TicketAssignees")
  creator      User               @relation("TicketCreator", fields: [createdBy], references: [id])
  project      Project?           @relation("ProjectTickets", fields: [projectId], references: [id], onDelete: SetNull)
  milestone    Milestone?         @relation("MilestoneTickets", fields: [milestoneId], references: [id], onDelete: SetNull)
  release      Release?           @relation("ReleaseTickets", fields: [releaseId], references: [id], onDelete: SetNull)
  module       Module?            @relation("ModuleTickets", fields: [moduleId], references: [id], onDelete: SetNull)
  cycle        Cycle?             @relation("CycleTickets", fields: [cycleId], references: [id], onDelete: SetNull)
  attributes   TicketAttribute[]  @relation("TicketAttributes")
  tags         TicketTag[]        @relation("TicketTags")
  comments     TicketComment[]    @relation("TicketComments")
  attachments  TicketAttachment[] @relation("TicketAttachments")
  timeLogs     TicketTimeLog[]    @relation("TicketTimeLogs")
  subtasks     Ticket[]           @relation("TicketSubtasks")
  parent       Ticket?            @relation("TicketSubtasks", fields: [parentId], references: [id])
  dependencies TicketDependency[] @relation("TicketDependencies")
  dependents   TicketDependency[] @relation("TicketDependents")

  @@map("tickets")
}

// Many-to-many: Tickets can belong to multiple spaces
model TicketSpace {
  id        String   @id @default(uuid()) @db.Uuid
  ticketId  String   @map("ticket_id") @db.Uuid
  spaceId   String   @map("space_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  ticket Ticket @relation("TicketSpaces", fields: [ticketId], references: [id], onDelete: Cascade)
  space  Space  @relation("SpaceTicketSpaces", fields: [spaceId], references: [id], onDelete: Cascade)

  @@unique([ticketId, spaceId])
  @@map("ticket_spaces")
}

// Many-to-many: Tickets can have multiple assignees
model TicketAssignee {
  id        String   @id @default(uuid()) @db.Uuid
  ticketId  String   @map("ticket_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      String   @default("ASSIGNEE") // ASSIGNEE, REVIEWER, WATCHER
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  ticket Ticket @relation("TicketAssignees", fields: [ticketId], references: [id], onDelete: Cascade)
  user   User   @relation("TicketAssignees", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([ticketId, userId])
  @@map("ticket_assignees")
}

// Tags for tickets
model TicketTag {
  id        String   @id @default(uuid()) @db.Uuid
  ticketId  String   @map("ticket_id") @db.Uuid
  name      String
  color     String? // Hex color
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  ticket Ticket @relation("TicketTags", fields: [ticketId], references: [id], onDelete: Cascade)

  @@unique([ticketId, name])
  @@map("ticket_tags")
}

// Custom attributes for tickets (similar to ClickUp custom fields)
model TicketAttribute {
  id          String   @id @default(uuid()) @db.Uuid
  ticketId    String   @map("ticket_id") @db.Uuid
  name        String
  displayName String   @map("display_name")
  type        String // TEXT, NUMBER, BOOLEAN, DATE, SELECT, MULTI_SELECT, USER, URL, EMAIL
  value       String? // For simple types
  jsonValue   Json?    @map("json_value") // For complex types (select options, etc.)
  isRequired  Boolean  @default(false) @map("is_required")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  ticket Ticket @relation("TicketAttributes", fields: [ticketId], references: [id], onDelete: Cascade)

  @@unique([ticketId, name])
  @@map("ticket_attributes")
}

// Comments on tickets
model TicketComment {
  id        String    @id @default(uuid()) @db.Uuid
  ticketId  String    @map("ticket_id") @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  content   String
  metadata  Json?     @default("{}")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  ticket Ticket @relation("TicketComments", fields: [ticketId], references: [id], onDelete: Cascade)
  author User   @relation("TicketCommentAuthor", fields: [userId], references: [id])

  @@map("ticket_comments")
}

// Attachments on tickets
model TicketAttachment {
  id         String   @id @default(uuid()) @db.Uuid
  ticketId   String   @map("ticket_id") @db.Uuid
  fileName   String   @map("file_name")
  filePath   String   @map("file_path")
  fileSize   Int      @map("file_size")
  mimeType   String   @map("mime_type")
  uploadedBy String?  @map("uploaded_by") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  ticket Ticket @relation("TicketAttachments", fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("ticket_attachments")
}

// Time tracking for tickets
model TicketTimeLog {
  id          String   @id @default(uuid()) @db.Uuid
  ticketId    String   @map("ticket_id") @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  description String?
  hours       Decimal  @db.Decimal(10, 2)
  loggedAt    DateTime @map("logged_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  ticket Ticket @relation("TicketTimeLogs", fields: [ticketId], references: [id], onDelete: Cascade)
  user   User   @relation("TicketTimeLogUser", fields: [userId], references: [id])

  @@map("ticket_time_logs")
}

// Dependencies between tickets
model TicketDependency {
  id          String   @id @default(uuid()) @db.Uuid
  ticketId    String   @map("ticket_id") @db.Uuid
  dependsOnId String   @map("depends_on_id") @db.Uuid
  type        String   @default("BLOCKS") // BLOCKS, BLOCKED_BY, RELATES_TO, PARENT, CHILD, DUPLICATE, CLONES
  metadata    Json?    @default("{}") // Visual metadata (position, color, etc.)
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  ticket    Ticket @relation("TicketDependencies", fields: [ticketId], references: [id], onDelete: Cascade)
  dependsOn Ticket @relation("TicketDependents", fields: [dependsOnId], references: [id], onDelete: Cascade)

  @@unique([ticketId, dependsOnId])
  @@map("ticket_dependencies")
}

// Kanban board configuration
model KanbanConfig {
  id          String   @id @default(uuid()) @db.Uuid
  spaceId     String   @map("space_id") @db.Uuid
  name        String
  description String?
  config      Json // Board configuration (rows, columns, grouping, etc.)
  isDefault   Boolean  @default(false) @map("is_default")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  space Space @relation("SpaceKanbanConfigs", fields: [spaceId], references: [id], onDelete: Cascade)

  @@map("kanban_configs")
}

// Intake forms for ticket creation
model IntakeForm {
  id          String   @id @default(uuid()) @db.Uuid
  spaceId     String   @map("space_id") @db.Uuid
  name        String
  description String?
  formFields  Json     @map("form_fields") // Form field definitions
  workflow    Json? // Workflow configuration
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  space       Space              @relation("SpaceIntakeForms", fields: [spaceId], references: [id], onDelete: Cascade)
  submissions IntakeSubmission[] @relation("IntakeFormSubmissions")

  @@map("intake_forms")
}

// Intake form submissions
model IntakeSubmission {
  id        String   @id @default(uuid()) @db.Uuid
  formId    String   @map("form_id") @db.Uuid
  userId    String?  @map("user_id") @db.Uuid
  data      Json // Submission data
  ticketId  String?  @map("ticket_id") @db.Uuid // If converted to ticket
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED, CONVERTED
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  form IntakeForm @relation("IntakeFormSubmissions", fields: [formId], references: [id], onDelete: Cascade)
  user User?      @relation("IntakeSubmissionUser", fields: [userId], references: [id], onDelete: SetNull)

  @@map("intake_submissions")
}

model ImportProfile {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  description String?   @db.Text
  dataModelId String    @map("data_model_id") @db.Uuid
  mapping     Json      @default("{}")
  settings    Json      @default("{}")
  createdBy   String    @map("created_by") @db.Uuid
  spaceId     String?   @map("space_id") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  creator User        @relation("ImportProfileCreator", fields: [createdBy], references: [id])
  space   Space?      @relation("SpaceImportProfiles", fields: [spaceId], references: [id])
  jobs    ImportJob[] @relation("ImportProfileJobs")

  @@map("import_profiles")
}

model ImportJob {
  id            String    @id @default(uuid()) @db.Uuid
  profileId     String?   @map("profile_id") @db.Uuid
  dataModelId   String    @map("data_model_id") @db.Uuid
  fileName      String    @map("file_name")
  fileSize      Int       @map("file_size")
  fileType      String    @map("file_type")
  status        String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED
  progress      Int       @default(0)
  totalRows     Int?      @map("total_rows")
  processedRows Int       @default(0) @map("processed_rows")
  errorMessage  String?   @map("error_message") @db.Text
  result        Json?
  mapping       Json      @default("{}")
  createdBy     String    @map("created_by") @db.Uuid
  spaceId       String?   @map("space_id") @db.Uuid
  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  profile ImportProfile? @relation("ImportProfileJobs", fields: [profileId], references: [id])
  creator User           @relation("ImportJobCreator", fields: [createdBy], references: [id])
  space   Space?         @relation("SpaceImportJobs", fields: [spaceId], references: [id])

  @@map("import_jobs")
}

model ExportJob {
  id            String    @id @default(uuid()) @db.Uuid
  dataModelId   String    @map("data_model_id") @db.Uuid
  format        String    @default("xlsx") // xlsx, csv, json, pdf
  status        String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED
  progress      Int       @default(0)
  totalRows     Int?      @map("total_rows")
  processedRows Int       @default(0) @map("processed_rows")
  errorMessage  String?   @map("error_message") @db.Text
  fileUrl       String?   @map("file_url")
  fileName      String?   @map("file_name")
  fileSize      Int?      @map("file_size")
  filters       Json      @default("{}")
  columns       Json      @default("[]")
  createdBy     String    @map("created_by") @db.Uuid
  spaceId       String?   @map("space_id") @db.Uuid
  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  creator User   @relation("ExportJobCreator", fields: [createdBy], references: [id])
  space   Space? @relation("SpaceExportJobs", fields: [spaceId], references: [id])

  @@map("export_jobs")
}

model Chatbot {
  id                 String    @id @default(uuid()) @db.Uuid
  name               String
  website            String?
  description        String?   @db.Text
  apiEndpoint        String    @map("api_endpoint")
  apiAuthType        String    @default("none") @map("api_auth_type")
  apiAuthValue       String?   @map("api_auth_value") @db.Text
  logo               String?
  primaryColor       String?   @map("primary_color")
  fontFamily         String?   @map("font_family")
  fontSize           String?   @map("font_size")
  fontColor          String?   @map("font_color")
  borderColor        String?   @map("border_color")
  borderWidth        String?   @map("border_width")
  borderRadius       String?   @map("border_radius")
  messageBoxColor    String?   @map("message_box_color")
  widgetBackgroundColor String? @map("widget_background_color")
  shadowColor        String?   @map("shadow_color")
  shadowBlur         String?   @map("shadow_blur")
  conversationOpener String?   @map("conversation_opener") @db.Text
  followUpQuestions  Json      @default("[]") @map("follow_up_questions")
  enableFileUpload   Boolean   @default(false) @map("enable_file_upload")
  showCitations      Boolean   @default(true) @map("show_citations")
  deploymentType     String    @default("popover") @map("deployment_type")
  engineType         String    @default("chatkit") @map("engine_type")
  customEmbedDomain  String?   @map("custom_embed_domain")
  isPublished        Boolean   @default(false) @map("is_published")
  currentVersion     String?   @map("current_version")
  createdBy          String    @map("created_by") @db.Uuid
  spaceId            String?   @map("space_id") @db.Uuid
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  deletedAt          DateTime? @map("deleted_at")

  // Relations
  creator            User                       @relation("ChatbotCreator", fields: [createdBy], references: [id])
  space              Space?                     @relation("SpaceChatbots", fields: [spaceId], references: [id])
  versions           ChatbotVersion[]           @relation("ChatbotVersions")
  threads            OpenAIAgentThread[]        @relation("ChatbotThreads")
  rateLimit          ChatbotRateLimit?          @relation("ChatbotRateLimits")
  cacheConfig        ChatbotCacheConfig?        @relation("ChatbotCacheConfigs")
  retryConfig        ChatbotRetryConfig?        @relation("ChatbotRetryConfigs")
  costBudget         ChatbotCostBudget?         @relation("ChatbotCostBudgets")
  costRecords        ChatbotCostRecord[]        @relation("ChatbotCostRecords")
  webhooks           ChatbotWebhook[]           @relation("ChatbotWebhooks")
  performanceMetrics ChatbotPerformanceMetric[] @relation("ChatbotPerformanceMetrics")
  customFunctions    ChatbotCustomFunction[]    @relation("ChatbotCustomFunctions")
  multiAgentConfig   ChatbotMultiAgentConfig?   @relation("ChatbotMultiAgentConfigs")
  lifecycleHooks     ChatbotLifecycleHook[]     @relation("ChatbotLifecycleHooks")
  connectors         ChatbotConnector[]         @relation("ChatbotConnectors")
  agentLoopConfig    ChatbotAgentLoopConfig?    @relation("ChatbotAgentLoopConfigs")

  @@map("chatbots")
}

model ChatbotVersion {
  id          String   @id @default(uuid()) @db.Uuid
  chatbotId   String   @map("chatbot_id") @db.Uuid
  version     String
  config      Json     @default("{}")
  isPublished Boolean  @default(false) @map("is_published")
  createdBy   String   @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  chatbot Chatbot @relation("ChatbotVersions", fields: [chatbotId], references: [id], onDelete: Cascade)
  creator User    @relation("ChatbotVersionCreator", fields: [createdBy], references: [id])

  @@map("chatbot_versions")
}

model OpenAIAgentThread {
  id            String    @id @default(uuid()) @db.Uuid
  threadId      String    @unique @map("thread_id") // OpenAI thread ID (thread_xxx)
  chatbotId     String    @map("chatbot_id") @db.Uuid
  userId        String?   @map("user_id") @db.Uuid
  spaceId       String?   @map("space_id") @db.Uuid
  title         String? // User-friendly title (auto-generated from first message)
  metadata      Json?     @default("{}") // Store additional metadata (agentId, model, etc.)
  messageCount  Int       @default(0) @map("message_count") // Track number of messages
  lastMessageAt DateTime? @map("last_message_at") // Last message timestamp
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  deletedAt     DateTime? @map("deleted_at")

  // Relations
  chatbot Chatbot @relation("ChatbotThreads", fields: [chatbotId], references: [id], onDelete: Cascade)
  user    User?   @relation("UserAgentThreads", fields: [userId], references: [id], onDelete: SetNull)
  space   Space?  @relation("SpaceAgentThreads", fields: [spaceId], references: [id], onDelete: Cascade)

  @@index([chatbotId, userId])
  @@index([threadId])
  @@map("openai_agent_threads")
}

// Rate Limiting Configuration
model ChatbotRateLimit {
  id                   String   @id @default(uuid()) @db.Uuid
  chatbotId            String   @unique @map("chatbot_id") @db.Uuid
  enabled              Boolean  @default(true)
  maxRequestsPerMinute Int?     @map("max_requests_per_minute") // Per user
  maxRequestsPerHour   Int?     @map("max_requests_per_hour") // Per user
  maxRequestsPerDay    Int?     @map("max_requests_per_day") // Per user
  maxRequestsPerMonth  Int?     @map("max_requests_per_month") // Per user
  burstLimit           Int?     @map("burst_limit") // Allow burst of N requests
  windowSize           Int?     @default(60) @map("window_size") // Window size in seconds
  blockDuration        Int?     @default(300) @map("block_duration") // Block duration in seconds when limit exceeded
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  chatbot Chatbot @relation("ChatbotRateLimits", fields: [chatbotId], references: [id], onDelete: Cascade)

  @@map("chatbot_rate_limits")
}

// Response Caching Configuration
model ChatbotCacheConfig {
  id             String   @id @default(uuid()) @db.Uuid
  chatbotId      String   @unique @map("chatbot_id") @db.Uuid
  enabled        Boolean  @default(true)
  ttl            Int      @default(3600) // Time to live in seconds (1 hour default)
  maxSize        Int      @default(1000) @map("max_size") // Maximum number of cached responses
  strategy       String   @default("exact") // 'exact', 'semantic', 'fuzzy'
  includeContext Boolean  @default(false) @map("include_context") // Include conversation context in cache key
  cacheKeyPrefix String?  @map("cache_key_prefix") // Optional prefix for cache keys
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  chatbot Chatbot @relation("ChatbotCacheConfigs", fields: [chatbotId], references: [id], onDelete: Cascade)

  @@map("chatbot_cache_configs")
}

// Retry Configuration
model ChatbotRetryConfig {
  id                   String   @id @default(uuid()) @db.Uuid
  chatbotId            String   @unique @map("chatbot_id") @db.Uuid
  enabled              Boolean  @default(true)
  maxRetries           Int      @default(3) @map("max_retries")
  initialDelay         Int      @default(1000) @map("initial_delay") // Initial delay in ms
  maxDelay             Int      @default(30000) @map("max_delay") // Maximum delay in ms
  backoffMultiplier    Float    @default(2.0) @map("backoff_multiplier")
  retryableStatusCodes String[] @default(["500", "502", "503", "504"]) @map("retryable_status_codes") // HTTP status codes to retry
  jitter               Boolean  @default(true) // Add randomness to delays
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  chatbot Chatbot @relation("ChatbotRetryConfigs", fields: [chatbotId], references: [id], onDelete: Cascade)

  @@map("chatbot_retry_configs")
}

// Cost Tracking and Budgets
model ChatbotCostBudget {
  id             String   @id @default(uuid()) @db.Uuid
  chatbotId      String   @unique @map("chatbot_id") @db.Uuid
  enabled        Boolean  @default(true)
  monthlyBudget  Decimal? @map("monthly_budget") @db.Decimal(10, 2) // Monthly budget in USD
  dailyBudget    Decimal? @map("daily_budget") @db.Decimal(10, 2) // Daily budget in USD
  alertThreshold Float    @default(0.8) @map("alert_threshold") // Alert at 80% of budget
  alertEmail     String?  @map("alert_email") // Email to send alerts to
  trackPerUser   Boolean  @default(false) @map("track_per_user") // Track costs per user
  trackPerThread Boolean  @default(false) @map("track_per_thread") // Track costs per thread
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  chatbot Chatbot @relation("ChatbotCostBudgets", fields: [chatbotId], references: [id], onDelete: Cascade)

  @@map("chatbot_cost_budgets")
}

// Cost Tracking Records
model ChatbotCostRecord {
  id           String   @id @default(uuid()) @db.Uuid
  chatbotId    String   @map("chatbot_id") @db.Uuid
  userId       String?  @map("user_id") @db.Uuid
  threadId     String?  @map("thread_id")
  traceId      String?  @map("trace_id")
  cost         Decimal  @db.Decimal(10, 6) // Cost in USD (high precision)
  inputTokens  Int?     @map("input_tokens")
  outputTokens Int?     @map("output_tokens")
  totalTokens  Int?     @map("total_tokens")
  model        String? // Model used (e.g., gpt-4, gpt-3.5-turbo)
  metadata     Json?    @default("{}") // Additional metadata
  recordedAt   DateTime @default(now()) @map("recorded_at")

  // Relations
  chatbot Chatbot @relation("ChatbotCostRecords", fields: [chatbotId], references: [id], onDelete: Cascade)
  user    User?   @relation("UserCostRecords", fields: [userId], references: [id], onDelete: SetNull)

  @@index([chatbotId, recordedAt])
  @@index([userId, recordedAt])
  @@index([threadId])
  @@map("chatbot_cost_records")
}

// Webhook Configuration for Chatbot Events
model ChatbotWebhook {
  id        String   @id @default(uuid()) @db.Uuid
  chatbotId String   @map("chatbot_id") @db.Uuid
  url       String // Webhook URL
  secret    String? // Optional secret for webhook signature
  events    String[] // Array of event types: 'budget_alert', 'budget_exceeded', 'rate_limit_exceeded', 'cost_threshold'
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  chatbot Chatbot @relation("ChatbotWebhooks", fields: [chatbotId], references: [id], onDelete: Cascade)

  @@index([chatbotId])
  @@map("chatbot_webhooks")
}

// Performance Metrics Tracking
model ChatbotPerformanceMetric {
  id         String   @id @default(uuid()) @db.Uuid
  chatbotId  String   @map("chatbot_id") @db.Uuid
  metricType String   @map("metric_type") // 'cache_hit', 'cache_miss', 'retry_attempt', 'retry_success', 'rate_limit_violation', 'response_time'
  value      Decimal  @db.Decimal(10, 4) // Metric value (e.g., response time in ms, cache hit count)
  metadata   Json?    @default("{}") // Additional context
  recordedAt DateTime @default(now()) @map("recorded_at")

  // Relations
  chatbot Chatbot @relation("ChatbotPerformanceMetrics", fields: [chatbotId], references: [id], onDelete: Cascade)

  @@index([chatbotId, metricType, recordedAt])
  @@index([recordedAt])
  @@map("chatbot_performance_metrics")
}

// Custom Function Tools for OpenAI Agent SDK
model ChatbotCustomFunction {
  id            String   @id @default(uuid()) @db.Uuid
  chatbotId     String   @map("chatbot_id") @db.Uuid
  name          String // Function name
  description   String   @db.Text // Function description for the agent
  parameters    Json // JSON schema for function parameters
  endpoint      String? // API endpoint to call (if external)
  code          String?  @db.Text // JavaScript/TypeScript code to execute (if inline)
  executionType String   @map("execution_type") // 'api', 'inline', 'webhook'
  enabled       Boolean  @default(true)
  metadata      Json?    @default("{}") // Additional configuration
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  chatbot Chatbot @relation("ChatbotCustomFunctions", fields: [chatbotId], references: [id], onDelete: Cascade)

  @@index([chatbotId])
  @@map("chatbot_custom_functions")
}

// Multi-Agent Coordination Configuration
model ChatbotMultiAgentConfig {
  id                   String   @id @default(uuid()) @db.Uuid
  chatbotId            String   @map("chatbot_id") @db.Uuid
  enabled              Boolean  @default(false)
  agents               Json // Array of agent configurations with handoff rules
  handoffRules         Json?    @default("{}") @map("handoff_rules") // Rules for agent handoffs
  coordinationStrategy String?  @map("coordination_strategy") // 'sequential', 'parallel', 'conditional'
  metadata             Json?    @default("{}")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  // Relations
  chatbot Chatbot @relation("ChatbotMultiAgentConfigs", fields: [chatbotId], references: [id], onDelete: Cascade)

  @@unique([chatbotId])
  @@map("chatbot_multi_agent_configs")
}

// Lifecycle Hooks Configuration
model ChatbotLifecycleHook {
  id          String   @id @default(uuid()) @db.Uuid
  chatbotId   String   @map("chatbot_id") @db.Uuid
  hookType    String   @map("hook_type") // 'before_execution', 'after_execution', 'on_tool_call', 'on_error', 'on_handoff'
  enabled     Boolean  @default(true)
  handlerType String   @map("handler_type") // 'api', 'inline', 'webhook'
  handlerUrl  String?  @map("handler_url") // API endpoint or webhook URL
  handlerCode String?  @map("handler_code") @db.Text // Inline code to execute
  metadata    Json?    @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  chatbot Chatbot @relation("ChatbotLifecycleHooks", fields: [chatbotId], references: [id], onDelete: Cascade)

  @@index([chatbotId, hookType])
  @@map("chatbot_lifecycle_hooks")
}

// Third-party Service Connectors
model ChatbotConnector {
  id            String   @id @default(uuid()) @db.Uuid
  chatbotId     String   @map("chatbot_id") @db.Uuid
  connectorType String   @map("connector_type") // 'gmail', 'google_drive', 'github', 'slack', etc.
  enabled       Boolean  @default(true)
  credentials   Json? // Encrypted OAuth tokens or API keys
  config        Json?    @default("{}") // Connector-specific configuration
  metadata      Json?    @default("{}")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  chatbot Chatbot @relation("ChatbotConnectors", fields: [chatbotId], references: [id], onDelete: Cascade)

  @@index([chatbotId, connectorType])
  @@map("chatbot_connectors")
}

// Agent Loop Configuration
model ChatbotAgentLoopConfig {
  id                String   @id @default(uuid()) @db.Uuid
  chatbotId         String   @map("chatbot_id") @db.Uuid
  maxIterations     Int?     @map("max_iterations") // Maximum agent loop iterations
  stopConditions    Json?    @default("{}") @map("stop_conditions") // Conditions to stop the loop
  timeout           Int? // Timeout in milliseconds
  enableHumanInLoop Boolean  @default(false) @map("enable_human_in_loop") // Enable human-in-the-loop pauses
  humanInLoopConfig Json?    @default("{}") @map("human_in_loop_config") // Configuration for human-in-the-loop
  metadata          Json?    @default("{}")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  // Relations
  chatbot Chatbot @relation("ChatbotAgentLoopConfigs", fields: [chatbotId], references: [id], onDelete: Cascade)

  @@unique([chatbotId])
  @@map("chatbot_agent_loop_configs")
}

// Asset Management Models
model Language {
  id         String   @id @default(uuid()) @db.Uuid
  code       String   @unique // ISO 639-1 code (e.g., 'en', 'es', 'fr')
  name       String // Native name (e.g., 'English', 'Espaol')
  nativeName String   @map("native_name") // Native name in that language
  flag       String? // Flag emoji or icon URL
  isActive   Boolean  @default(true) @map("is_active")
  isDefault  Boolean  @default(false) @map("is_default")
  sortOrder  Int      @default(0) @map("sort_order")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  localizations Localization[] @relation("LanguageLocalizations")

  @@map("languages")
}

model AssetType {
  id          String    @id @default(uuid()) @db.Uuid
  code        String    @unique // Unique code (e.g., 'database_type', 'system_type', 'cms_type')
  name        String // Display name
  description String?   @db.Text
  category    String // 'database', 'system', 'cms', 'other'
  isActive    Boolean   @default(true) @map("is_active")
  isSystem    Boolean   @default(false) @map("is_system") // System types cannot be deleted
  sortOrder   Int       @default(0) @map("sort_order")
  metadata    Json?     @default("{}") // Additional configuration
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  assets Asset[] @relation("AssetTypeAssets")

  @@map("asset_types")
}

model Asset {
  id          String    @id @default(uuid()) @db.Uuid
  assetTypeId String    @map("asset_type_id") @db.Uuid
  code        String // Unique code within type (e.g., 'postgresql', 'mysql')
  name        String // Display name
  description String?   @db.Text
  logo        String? // Logo URL or path
  icon        String? // Icon URL or emoji
  color       String? // Primary color (hex)
  isActive    Boolean   @default(true) @map("is_active")
  isSystem    Boolean   @default(false) @map("is_system") // System assets cannot be deleted
  sortOrder   Int       @default(0) @map("sort_order")
  metadata    Json?     @default("{}") // Additional data (ports, versions, etc.)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  assetType AssetType @relation("AssetTypeAssets", fields: [assetTypeId], references: [id], onDelete: Cascade)

  @@unique([assetTypeId, code])
  @@map("assets")
}

model Localization {
  id         String   @id @default(uuid()) @db.Uuid
  languageId String   @map("language_id") @db.Uuid
  entityType String   @map("entity_type") // 'asset_type', 'asset', 'system'
  entityId   String   @map("entity_id") @db.Uuid
  field      String // Field name (e.g., 'name', 'description')
  value      String   @db.Text // Translated value
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  language Language @relation("LanguageLocalizations", fields: [languageId], references: [id], onDelete: Cascade)

  @@unique([languageId, entityType, entityId, field])
  @@index([entityType, entityId])
  @@map("localizations")
}

model StorageConnection {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  type        String // 'minio', 's3', 'sftp', 'onedrive', 'google_drive'
  config      Json // Provider-specific configuration (encrypted in production)
  isActive    Boolean   @default(true) @map("is_active")
  status      String    @default("disconnected") // 'connected', 'disconnected', 'error'
  lastTested  DateTime? @map("last_tested")
  lastError   String?   @map("last_error") @db.Text
  description String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("storage_connections")
}

// Marketplace Models
model ServiceRegistry {
  id                String    @id @default(uuid()) @db.Uuid
  name              String
  slug              String    @unique
  description       String?   @db.Text
  version           String
  provider          String
  providerUrl       String?   @map("provider_url")
  category          String? // 'business-intelligence', 'service-management', etc.
  status            String    @default("pending") // 'pending', 'approved', 'rejected', 'deprecated'
  capabilities      Json?     @default("{}")
  apiBaseUrl        String?   @map("api_base_url")
  apiAuthType       String?   @map("api_auth_type") // 'oauth2', 'api_key', 'bearer', 'none'
  apiAuthConfig     Json?     @default("{}") @map("api_auth_config")
  uiType            String?   @map("ui_type") // 'iframe', 'react_component', 'web_component'
  uiConfig          Json?     @default("{}") @map("ui_config")
  webhookSupported  Boolean   @default(false) @map("webhook_supported")
  webhookEvents     String[]  @map("webhook_events")
  iconUrl           String?   @map("icon_url")
  screenshots       String[]
  documentationUrl  String?   @map("documentation_url")
  supportUrl        String?   @map("support_url")
  pricingInfo       Json?     @map("pricing_info")
  installationCount Int       @default(0) @map("installation_count")
  rating            Decimal?  @db.Decimal(3, 2)
  reviewCount       Int       @default(0) @map("review_count")
  verified          Boolean   @default(false)
  securityAudit     Json?     @map("security_audit")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  deletedAt         DateTime? @map("deleted_at")

  // Relations
  installations         ServiceInstallation[]         @relation("ServiceRegistryInstallations")
  uiComponents          ServiceUIComponent[]          @relation("ServiceRegistryUIComponents")
  apiRoutes             ServiceAPIRoute[]             @relation("ServiceRegistryAPIRoutes")
  managementPlugins     InstanceService[]             @relation("ServiceRegistryManagementPlugins")
  managementAssignments ServiceManagementAssignment[] @relation("ServiceRegistryManagementAssignments")
  reviews               PluginReview[]                @relation("ServiceRegistryReviews")

  @@index([category])
  @@index([status])
  @@index([verified])
  @@map("service_registry")
}

model ServiceInstallation {
  id              String    @id @default(uuid()) @db.Uuid
  serviceId       String    @map("service_id") @db.Uuid
  spaceId         String?   @map("space_id") @db.Uuid
  installedBy     String?   @map("installed_by") @db.Uuid
  config          Json?     @default("{}")
  credentials     Json?     @default("{}") // Encrypted
  status          String    @default("active") // 'active', 'inactive', 'error'
  lastHealthCheck DateTime? @map("last_health_check")
  healthStatus    String?   @map("health_status")
  permissions     Json?     @default("{}")
  installedAt     DateTime  @default(now()) @map("installed_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")

  // Relations
  service      ServiceRegistry      @relation("ServiceRegistryInstallations", fields: [serviceId], references: [id], onDelete: Cascade)
  space        Space?               @relation("SpaceServiceInstallations", fields: [spaceId], references: [id], onDelete: Cascade)
  installer    User?                @relation("UserServiceInstallations", fields: [installedBy], references: [id])
  uiComponents ServiceUIComponent[] @relation("ServiceInstallationUIComponents")
  apiRoutes    ServiceAPIRoute[]    @relation("ServiceInstallationAPIRoutes")

  @@unique([serviceId, spaceId])
  @@index([spaceId])
  @@index([serviceId])
  @@index([status])
  @@map("service_installations")
}

model ServiceUIComponent {
  id                  String   @id @default(uuid()) @db.Uuid
  serviceId           String   @map("service_id") @db.Uuid
  installationId      String?  @map("installation_id") @db.Uuid
  componentType       String?  @map("component_type") // 'widget', 'page', 'sidebar', 'modal'
  componentName       String?  @map("component_name")
  componentId         String?  @map("component_id")
  renderType          String?  @map("render_type") // 'iframe', 'react', 'web_component'
  renderConfig        Json?    @default("{}") @map("render_config")
  placement           String? // 'dashboard', 'sidebar', 'settings'
  placementConfig     Json?    @default("{}") @map("placement_config")
  requiredPermissions String[] @map("required_permissions")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  service      ServiceRegistry      @relation("ServiceRegistryUIComponents", fields: [serviceId], references: [id], onDelete: Cascade)
  installation ServiceInstallation? @relation("ServiceInstallationUIComponents", fields: [installationId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([installationId])
  @@map("service_ui_components")
}

model ServiceAPIRoute {
  id              String   @id @default(uuid()) @db.Uuid
  serviceId       String   @map("service_id") @db.Uuid
  installationId  String?  @map("installation_id") @db.Uuid
  routePath       String   @map("route_path")
  method          String
  targetUrl       String   @map("target_url")
  authType        String?  @map("auth_type")
  authConfig      Json?    @default("{}") @map("auth_config")
  rateLimit       Int?     @map("rate_limit")
  rateLimitWindow Int?     @map("rate_limit_window")
  cacheEnabled    Boolean  @default(false) @map("cache_enabled")
  cacheTtl        Int?     @map("cache_ttl")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  service      ServiceRegistry      @relation("ServiceRegistryAPIRoutes", fields: [serviceId], references: [id], onDelete: Cascade)
  installation ServiceInstallation? @relation("ServiceInstallationAPIRoutes", fields: [installationId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([installationId])
  @@map("service_api_routes")
}

// Infrastructure Models
model InfrastructureInstance {
  id               String    @id @default(uuid()) @db.Uuid
  name             String
  type             String // 'vm', 'docker_host', 'kubernetes', 'cloud_instance'
  host             String
  port             Int?
  protocol         String    @default("ssh")
  connectionType   String    @map("connection_type") // 'ssh', 'docker_api', 'kubernetes', 'http'
  connectionConfig Json?     @default("{}") @map("connection_config")
  status           String    @default("unknown") // 'online', 'offline', 'error'
  lastHealthCheck  DateTime? @map("last_health_check")
  healthStatus     Json?     @default("{}") @map("health_status")
  osType           String?   @map("os_type")
  osVersion        String?   @map("os_version")
  resources        Json? // { cpu, memory, disk }
  tags             String[]
  spaceId          String?   @map("space_id") @db.Uuid
  createdBy        String?   @map("created_by") @db.Uuid
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  deletedAt        DateTime? @map("deleted_at")

  // Relations
  space    Space?            @relation("SpaceInfrastructureInstances", fields: [spaceId], references: [id], onDelete: Cascade)
  creator  User?             @relation("UserInfrastructureInstances", fields: [createdBy], references: [id])
  services InstanceService[] @relation("InfrastructureInstanceServices")

  @@index([spaceId])
  @@index([type])
  @@index([status])
  @@map("infrastructure_instances")
}

model InstanceService {
  id                 String   @id @default(uuid()) @db.Uuid
  instanceId         String   @map("instance_id") @db.Uuid
  name               String
  type               String // 'docker_container', 'systemd_service', 'application'
  status             String   @default("unknown") // 'running', 'stopped', 'error'
  serviceConfig      Json?    @default("{}") @map("service_config")
  endpoints          Json?    @default("[]")
  healthCheckUrl     String?  @map("health_check_url")
  managementPluginId String?  @map("management_plugin_id") @db.Uuid
  managementConfig   Json?    @default("{}") @map("management_config")
  discoveredAt       DateTime @default(now()) @map("discovered_at")
  lastSeen           DateTime @default(now()) @map("last_seen")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  instance              InfrastructureInstance        @relation("InfrastructureInstanceServices", fields: [instanceId], references: [id], onDelete: Cascade)
  managementPlugin      ServiceRegistry?              @relation("ServiceRegistryManagementPlugins", fields: [managementPluginId], references: [id])
  managementAssignments ServiceManagementAssignment[] @relation("InstanceServiceManagementAssignments")

  @@unique([instanceId, name, type])
  @@index([instanceId])
  @@index([managementPluginId])
  @@index([status])
  @@map("instance_services")
}

model ServiceManagementAssignment {
  id                String    @id @default(uuid()) @db.Uuid
  instanceServiceId String    @map("instance_service_id") @db.Uuid
  pluginId          String    @map("plugin_id") @db.Uuid
  assignedBy        String?   @map("assigned_by") @db.Uuid
  assignedAt        DateTime  @default(now()) @map("assigned_at")
  config            Json?     @default("{}")
  credentials       Json?     @default("{}")
  isActive          Boolean   @default(true) @map("is_active")
  lastUsed          DateTime? @map("last_used")

  // Relations
  instanceService InstanceService @relation("InstanceServiceManagementAssignments", fields: [instanceServiceId], references: [id], onDelete: Cascade)
  plugin          ServiceRegistry @relation("ServiceRegistryManagementAssignments", fields: [pluginId], references: [id], onDelete: Cascade)
  assigner        User?           @relation("UserServiceManagementAssignments", fields: [assignedBy], references: [id])

  @@unique([instanceServiceId, pluginId])
  @@index([instanceServiceId])
  @@index([pluginId])
  @@map("service_management_assignments")
}

// Plugin Review Models
model PluginReview {
  id           String    @id @default(uuid()) @db.Uuid
  serviceId    String    @map("service_id") @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  spaceId      String?   @map("space_id") @db.Uuid
  rating       Int // 1-5 stars
  title        String?
  comment      String?   @db.Text
  helpfulCount Int       @default(0) @map("helpful_count")
  isVerified   Boolean   @default(false) @map("is_verified")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  // Relations
  service ServiceRegistry       @relation("ServiceRegistryReviews", fields: [serviceId], references: [id], onDelete: Cascade)
  user    User                  @relation("UserPluginReviews", fields: [userId], references: [id], onDelete: Cascade)
  space   Space?                @relation("SpacePluginReviews", fields: [spaceId], references: [id], onDelete: Cascade)
  helpful PluginReviewHelpful[] @relation("ReviewHelpful")

  @@unique([serviceId, userId, spaceId])
  @@index([serviceId])
  @@index([userId])
  @@index([spaceId])
  @@index([rating])
  @@map("plugin_reviews")
}

model PluginReviewHelpful {
  id        String   @id @default(uuid()) @db.Uuid
  reviewId  String   @map("review_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  review PluginReview @relation("ReviewHelpful", fields: [reviewId], references: [id], onDelete: Cascade)
  user   User         @relation("UserPluginReviewHelpful", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reviewId, userId])
  @@index([reviewId])
  @@index([userId])
  @@map("plugin_review_helpful")
}

// Outline-like Knowledge Base Models
model KnowledgeCollection {
  id          String    @id @default(uuid()) @db.Uuid
  name        String
  description String?   @db.Text
  icon        String?
  color       String?
  isPrivate   Boolean   @default(false) @map("is_private")
  spaceId     String?   @map("space_id") @db.Uuid
  createdBy   String    @map("created_by") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  creator   User                        @relation("UserKnowledgeCollections", fields: [createdBy], references: [id])
  space     Space?                      @relation("SpaceKnowledgeCollections", fields: [spaceId], references: [id], onDelete: Cascade)
  documents KnowledgeDocument[]         @relation("CollectionDocuments")
  members   KnowledgeCollectionMember[] @relation("CollectionMembers")
  shares    KnowledgeShare[]            @relation("CollectionShares")

  @@index([spaceId])
  @@index([createdBy])
  @@index([deletedAt])
  @@map("knowledge_collections")
}

model KnowledgeCollectionMember {
  id           String   @id @default(uuid()) @db.Uuid
  collectionId String   @map("collection_id") @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  role         String   @default("viewer") // 'viewer', 'editor', 'admin'
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  collection KnowledgeCollection @relation("CollectionMembers", fields: [collectionId], references: [id], onDelete: Cascade)
  user       User                @relation("UserKnowledgeCollectionMembers", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([collectionId, userId])
  @@index([collectionId])
  @@index([userId])
  @@map("knowledge_collection_members")
}

model KnowledgeDocument {
  id           String    @id @default(uuid()) @db.Uuid
  collectionId String    @map("collection_id") @db.Uuid
  title        String
  content      String    @db.Text
  contentHtml  String?   @map("content_html") @db.Text
  parentId     String?   @map("parent_id") @db.Uuid
  templateId   String?   @map("template_id") @db.Uuid
  isTemplate   Boolean   @default(false) @map("is_template")
  isPublic     Boolean   @default(false) @map("is_public")
  isPinned     Boolean   @default(false) @map("is_pinned")
  publishedAt  DateTime? @map("published_at")
  archivedAt   DateTime? @map("archived_at")
  order        Int       @default(0)
  createdBy    String    @map("created_by") @db.Uuid
  updatedBy    String?   @map("updated_by") @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  deletedAt    DateTime? @map("deleted_at")

  // Relations
  collection KnowledgeCollection        @relation("CollectionDocuments", fields: [collectionId], references: [id], onDelete: Cascade)
  parent     KnowledgeDocument?         @relation("DocumentHierarchy", fields: [parentId], references: [id])
  children   KnowledgeDocument[]        @relation("DocumentHierarchy")
  creator    User                       @relation("UserKnowledgeDocuments", fields: [createdBy], references: [id])
  updater    User?                      @relation("UserKnowledgeDocumentUpdates", fields: [updatedBy], references: [id])
  comments   KnowledgeComment[]         @relation("DocumentComments")
  shares     KnowledgeShare[]           @relation("DocumentShares")
  versions   KnowledgeDocumentVersion[] @relation("DocumentVersions")
  stars      KnowledgeStar[]            @relation("DocumentStars")
  mentions   KnowledgeMention[]         @relation("DocumentMentions")
  presence   KnowledgePresence[]        @relation("DocumentPresence")

  @@index([collectionId])
  @@index([parentId])
  @@index([createdBy])
  @@index([deletedAt])
  @@index([isPublic])
  @@map("knowledge_documents")
}

model KnowledgeDocumentVersion {
  id          String   @id @default(uuid()) @db.Uuid
  documentId  String   @map("document_id") @db.Uuid
  title       String
  content     String   @db.Text
  contentHtml String?  @map("content_html") @db.Text
  createdBy   String   @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  document KnowledgeDocument @relation("DocumentVersions", fields: [documentId], references: [id], onDelete: Cascade)
  creator  User              @relation("UserKnowledgeDocumentVersions", fields: [createdBy], references: [id])

  @@index([documentId])
  @@index([createdAt])
  @@map("knowledge_document_versions")
}

model KnowledgeComment {
  id          String    @id @default(uuid()) @db.Uuid
  documentId  String    @map("document_id") @db.Uuid
  parentId    String?   @map("parent_id") @db.Uuid
  content     String    @db.Text
  contentHtml String?   @map("content_html") @db.Text
  resolvedAt  DateTime? @map("resolved_at")
  resolvedBy  String?   @map("resolved_by") @db.Uuid
  createdBy   String    @map("created_by") @db.Uuid
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  document KnowledgeDocument  @relation("DocumentComments", fields: [documentId], references: [id], onDelete: Cascade)
  parent   KnowledgeComment?  @relation("CommentThread", fields: [parentId], references: [id])
  replies  KnowledgeComment[] @relation("CommentThread")
  creator  User               @relation("UserKnowledgeComments", fields: [createdBy], references: [id])
  resolver User?              @relation("UserKnowledgeCommentResolutions", fields: [resolvedBy], references: [id])

  @@index([documentId])
  @@index([parentId])
  @@index([createdBy])
  @@index([deletedAt])
  @@map("knowledge_comments")
}

model KnowledgeShare {
  id           String    @id @default(uuid()) @db.Uuid
  documentId   String?   @map("document_id") @db.Uuid
  collectionId String?   @map("collection_id") @db.Uuid
  userId       String?   @map("user_id") @db.Uuid
  teamId       String?   @map("team_id") @db.Uuid
  permission   String    @default("read") // 'read', 'write', 'admin'
  publicLink   String?   @unique @map("public_link")
  expiresAt    DateTime? @map("expires_at")
  createdBy    String    @map("created_by") @db.Uuid
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  // Relations
  document   KnowledgeDocument?   @relation("DocumentShares", fields: [documentId], references: [id], onDelete: Cascade)
  collection KnowledgeCollection? @relation("CollectionShares", fields: [collectionId], references: [id], onDelete: Cascade)
  user       User?                @relation("UserKnowledgeShares", fields: [userId], references: [id], onDelete: Cascade)
  creator    User                 @relation("UserKnowledgeShareCreators", fields: [createdBy], references: [id])

  @@index([documentId])
  @@index([collectionId])
  @@index([userId])
  @@index([publicLink])
  @@map("knowledge_shares")
}

model KnowledgeStar {
  id         String   @id @default(uuid()) @db.Uuid
  documentId String   @map("document_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  document KnowledgeDocument @relation("DocumentStars", fields: [documentId], references: [id], onDelete: Cascade)
  user     User              @relation("UserKnowledgeStars", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([documentId, userId])
  @@index([documentId])
  @@index([userId])
  @@map("knowledge_stars")
}

model KnowledgeMention {
  id         String   @id @default(uuid()) @db.Uuid
  documentId String   @map("document_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  createdBy  String   @map("created_by") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  document KnowledgeDocument @relation("DocumentMentions", fields: [documentId], references: [id], onDelete: Cascade)
  user     User              @relation("UserKnowledgeMentions", fields: [userId], references: [id], onDelete: Cascade)
  creator  User              @relation("UserKnowledgeMentionCreators", fields: [createdBy], references: [id])

  @@unique([documentId, userId, createdBy])
  @@index([documentId])
  @@index([userId])
  @@map("knowledge_mentions")
}

model KnowledgePresence {
  id         String   @id @default(uuid()) @db.Uuid
  documentId String   @map("document_id") @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  cursor     Json? // { line: number, ch: number }
  selection  Json? // { from: {line, ch}, to: {line, ch} }
  lastSeen   DateTime @default(now()) @map("last_seen")

  // Relations
  document KnowledgeDocument @relation("DocumentPresence", fields: [documentId], references: [id], onDelete: Cascade)
  user     User              @relation("UserKnowledgePresence", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([documentId, userId])
  @@index([documentId])
  @@index([userId])
  @@index([lastSeen])
  @@map("knowledge_presence")
}

// API Client Models (Hoppscotch-like)
model ApiWorkspace {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  description String?
  isPersonal  Boolean  @default(true) @map("is_personal")
  spaceId     String?  @map("space_id") @db.Uuid
  createdBy   String   @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  creator      User             @relation("UserApiWorkspaces", fields: [createdBy], references: [id])
  space        Space?           @relation("SpaceApiWorkspaces", fields: [spaceId], references: [id], onDelete: Cascade)
  collections  ApiCollection[]  @relation("WorkspaceCollections")
  environments ApiEnvironment[] @relation("WorkspaceEnvironments")

  @@index([createdBy])
  @@index([spaceId])
  @@map("api_workspaces")
}

model ApiCollection {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  parentId    String?  @map("parent_id") @db.Uuid
  name        String
  description String?
  order       Int      @default(0)
  createdBy   String   @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  workspace ApiWorkspace    @relation("WorkspaceCollections", fields: [workspaceId], references: [id], onDelete: Cascade)
  parent    ApiCollection?  @relation("CollectionHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  ApiCollection[] @relation("CollectionHierarchy")
  requests  ApiRequest[]    @relation("CollectionRequests")
  creator   User            @relation("UserApiCollections", fields: [createdBy], references: [id])

  @@index([workspaceId])
  @@index([parentId])
  @@index([createdBy])
  @@map("api_collections")
}

model ApiRequest {
  id               String   @id @default(uuid()) @db.Uuid
  collectionId     String?  @map("collection_id") @db.Uuid
  name             String
  method           String   @default("GET") // GET, POST, PUT, DELETE, PATCH, etc.
  url              String
  headers          Json     @default("[]") // Array of {key, value, enabled}
  params           Json     @default("[]") // Array of {key, value, enabled}
  body             String?  @db.Text
  bodyType         String?  @map("body_type") // json, form-data, x-www-form-urlencoded, raw, etc.
  authType         String?  @map("auth_type") // none, bearer, basic, oauth2, apikey
  authConfig       Json?    @map("auth_config")
  preRequestScript String?  @map("pre_request_script") @db.Text
  testScript       String?  @map("test_script") @db.Text
  requestType      String   @default("REST") @map("request_type") // REST, GraphQL, WebSocket, SSE, SocketIO, MQTT
  graphqlQuery     String?  @map("graphql_query") @db.Text
  graphqlVariables String?  @map("graphql_variables") @db.Text
  order            Int      @default(0)
  createdBy        String   @map("created_by") @db.Uuid
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  collection ApiCollection?      @relation("CollectionRequests", fields: [collectionId], references: [id], onDelete: SetNull)
  creator    User                @relation("UserApiRequests", fields: [createdBy], references: [id])
  history    ApiRequestHistory[] @relation("RequestHistory")

  @@index([collectionId])
  @@index([createdBy])
  @@map("api_requests")
}

model ApiEnvironment {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  name        String
  variables   Json     @default("[]") // Array of {key, value, enabled}
  isGlobal    Boolean  @default(false) @map("is_global")
  createdBy   String   @map("created_by") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  workspace ApiWorkspace @relation("WorkspaceEnvironments", fields: [workspaceId], references: [id], onDelete: Cascade)
  creator   User         @relation("UserApiEnvironments", fields: [createdBy], references: [id])

  @@index([workspaceId])
  @@index([createdBy])
  @@map("api_environments")
}

model ApiRequestHistory {
  id              String   @id @default(uuid()) @db.Uuid
  requestId       String?  @map("request_id") @db.Uuid
  method          String
  url             String
  headers         Json     @default("{}")
  body            String?  @db.Text
  statusCode      Int?     @map("status_code")
  statusText      String?  @map("status_text")
  responseHeaders Json?    @map("response_headers") @db.JsonB
  responseBody    String?  @map("response_body") @db.Text
  responseTime    Int?     @map("response_time") // milliseconds
  error           String?  @db.Text
  createdBy       String   @map("created_by") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  request ApiRequest? @relation("RequestHistory", fields: [requestId], references: [id], onDelete: SetNull)
  creator User        @relation("UserApiRequestHistory", fields: [createdBy], references: [id])

  @@index([requestId])
  @@index([createdBy])
  @@index([createdAt])
  @@map("api_request_history")
}

// Theme Management Model
model Theme {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  description String?
  themeMode   String   @default("light") @map("theme_mode") // 'light' or 'dark' - each theme is either light or dark
  tags        String[] @default([]) // Array of tags for filtering (e.g., ["light", "macos", "premium"])
  isActive    Boolean  @default(false) @map("is_active")
  isDefault   Boolean  @default(false) @map("is_default")
  config      Json     @db.JsonB // BrandingConfig (flattened structure, no light/dark separation)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([isActive])
  @@index([isDefault])
  @@index([themeMode])
  @@index([tags], type: Gin) // GIN index for array search
  @@map("themes")
}

// PWA Builder Configuration
model WebsitePWA {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  description String?  @db.Text
  url         String   // The website URL where this PWA will be installed
  
  // Branding
  iconUrl     String?  @map("icon_url")
  themeColor  String?  @default("#ffffff") @map("theme_color")
  bgColor     String?  @default("#ffffff") @map("bg_color")
  shortName   String?  @map("short_name")
  
  // Manifest Settings
  displayMode String   @default("standalone") @map("display_mode") // standalone, minimal-ui, fullscreen, browser
  orientation String   @default("any") // any, natural, portrait, landscape
  scope       String   @default("/")
  startUrl    String   @default("/") @map("start_url")
  
  // Extended Metadata
  screenshots String[] @default([])
  categories  String[] @default([])
  shortcuts   Json?    @default("[]") // Array of {name, url, icons}
  manifestParams Json? @default("{}") // Additional manifest properties (dir, lang, etc.)
  
  // Install Prompt Settings
  installMode String   @default("browser") @map("install_mode") // browser, custom, manual
  promptDelay Int      @default(0) @map("prompt_delay") // seconds before showing prompt
  installBannerConfig Json? @default("{}") @map("install_banner_config") // Custom styling for the banner
  
  // Metadata & Status
  isPublished Boolean  @default(false) @map("is_published")
  currentVersion String? @map("current_version")
  
  createdBy   String   @map("created_by") @db.Uuid
  spaceId     String?  @map("space_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  // Relations
  creator     User     @relation("WebsitePWACreator", fields: [createdBy], references: [id])
  space       Space?   @relation("SpaceWebsitePWAs", fields: [spaceId], references: [id])
  versions    WebsitePWAVersion[] @relation("WebsitePWAVersions")
  
  @@map("website_pwas")
}

model WebsitePWAVersion {
  id            String   @id @default(uuid()) @db.Uuid
  pwaId         String   @map("pwa_id") @db.Uuid
  version       String   // e.g., 1.0.0
  config        Json     // Full snapshot of configuration
  changeLog     String?  @map("change_log")
  
  isPublished   Boolean  @default(false) @map("is_published")
  publishedAt   DateTime? @map("published_at")
  
  createdBy     String   @map("created_by") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at")

  // Relations
  pwa         WebsitePWA @relation("WebsitePWAVersions", fields: [pwaId], references: [id], onDelete: Cascade)
  creator     User       @relation("WebsitePWAVersionCreator", fields: [createdBy], references: [id])

  @@map("website_pwa_versions")
}
